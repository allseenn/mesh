# Распределенные системы и сети

## Урок 2.Облачные вычисления

### Домашнее задание

Развертывание свой системы визуализации при помощи Docker.

Открытие всех необходимых портов (80, 443, 1880, 1883, 1871, 3000, 8086 или тех, что были выбраны/заданы в процессе настройки).

Предоставление реквизитов доступа по публичному ip в формате: название сервиса: ссылка (http://ipaddr:port).

## Решение

Система визуализации развернута на компьютере с установленной на нем ОС Ubuntu 22.04.

При помощи Docker compose развернуты контейнеры: Grafana, InfluxDB, Mosquitto, NodeRed, Telegraf, WireGuard.

Контейнеры имеют общее виртуальное сетевое окружение с проброшенными портами в локальную сеть.

<img src=pics/00.png>

На основном роутере локальной сети с внешнего публичного IP-адреса, проброшены соответствующие (443, 8081) порты на порты веб-сервера nginx на ОС Centos 7.9, который в свою очередь проксирует запросы на нужные службы.

DOMEN с помощью DDNS-службы, привязан в публичному адресу основного роутера.

Данная архитектура сети позволяет:

1. Получить TLS сертификат от автаризационного сервиса Letsencrypt для DOMEN
2. Связка Nginx + TLS сертификат позволяет обращаться к службам визуализации на контейнерах Docker по защищенному соединению, по технологии обратного прокси.
3. Сократить количество открытых портов на внешнем IP-адресе основного роутера сети.

### Подключение

В коментариях к данной Домашней работы №2 на портале gb.ru прикреплены следующие данные:

- USERNAME - имя пользователя, одинаковое для всех служб визуализации
- PASSWORD - пароль, одинаковый для всех служб визуализации
- DOMEN - FQDN, домен третьего уровня, связанного с внешним IP-адресом роутера сети.

### Подключение к службам визуализации

1. Influxdb

https://DOMEN

2. NodeRed

https://DOMEN/nodered

3. Grafana

https://DOMEN/grafana

4. Telegraf

https//DOMEN:8081 (websocket)

В целях безопасности наружу проброшен порт 8081 для подключения к MQTT брокеру по защищенному соединению используя вебсокет.

Консольный клиент mosquitto_pub - не поддерживает вебсокеты, поэтому рекомендую использовать, другие клиенты mqtt.

Например, [MQTTX](https://mqttx.app/) поддерживает ОС Windows, MacOS, Linux

Для установки на линукс из snapd, используйте следующую команду

```
snap install mqttx
```

Для подключения по зашифрованному вебсокету wss необходимо в основном меню программы (расположенном слева) нажать на значок + (плюс)

<img src=pics/01.png>

В настройках соединения ввести

<img src=pics/02.png>

- Name - любое желаемое
- Client ID - любой
- Host - префикс хоста выбрать wss:// DOMEN - мой домен прикрепленный к коментам ДЗ№2 на gb.ru
- Path - /IoT (или /mqtt)
- Port - 8081
- Username - USERNAME
- Password - PASSWORD
- SSL/TLS - on
- SSL Secure - on

Для отправки сообщения mqtt брокеру можно выбрать из выпадающего меню, нижнее окошко редактора сообщения, формат "Plaintext"

<img src=pics/03.png>

Задать тему, например IoT, и внести в тело сообщения любой текст, например температуру 25

<img src=pics/04.png>

Для отправки сообщения необходимо нажать на зеленую круглую кнопку с эмблемой бумажного самолетика.
