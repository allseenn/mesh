# Распределенные системы и сети

## Урок 5. Mesh-сети

### Домашнее задание

Проведение радиообследования Wi-Fi покрытия и предоставление итоговых результатов, с их интерпретацией и рекомендациями по улучшению.

<div style="page-break-before: always;"></div>

## Введение

Домашняя локальной сеть, в основном, построена на витой паре, из соображений безопасности, помехоустойчивости, меньшей латентности и большей скорости. К этой сети подключены ПК, ноутбуки, телевизоры, принтеры, приставки, ip-телефоны и т.д.

Личные смартфоны имеют мобильный интернет и не используются для работы или просмотра фильмов.

Единственная точка доступа wifi расположена у входа и настроена только на гостевом режим, без возможности доступа в локалку, ее мощности достаточно для покрытия сигналом гостиной и кухни, где обычно бывают гости.  Телевидение и стационарный телефон доставляются в спальни по кабелю.

Но, по нашей легенде будем подключать IoT устройства, и в них же, вся суть проблемы, ее раскрою постепенно.

## Решение

На семинаре рекомендовано ПО [Wi-Fi Surveyor](https://github.com/ecoAPM/WiFiSurveyor), последняя бинарная сборка которого, состоялась полтора года назад.

Но, судя по гитхабу, проект хоть и не очень активный, но все еще живой и пулл-реквесты обрабатываются примерно раз в неделю.

Более свежую программу можно собрать самому из исходников, но этот шаг осилят не все админы, не говоря уже про обычного пользователя.

<div style="page-break-before: always;"></div>

### Установка ПО

<img src=pics/00.png width=300>

Долгое сканирование virustotal ничего не нашло, что не исключает обфускацию злоумышленником бинарного файла. Сам exe-файл подозрительно огромный, ни намека на модульность и MVC-подход.

### RSSI

<img src=pics/01.png>

На картинке отчетливо видно, что сигнал приемлемый только на кухне и в гостинной. Чем дальше от точки доступа тем хуже сигнал.

### SNR

<img src=pics/02.png>

Картина примерно аналогичная, только, по неведомым пока причинам сигнала нет в сан.комнатах.

### Варианты усиления сигнала

Если бы задача стояла покрыть wi-fi не гостевую зону, а всю квартиру, то варианта, исходя из картинок, только два:

1. Перемещение точки доступа ближе к спальням, что неминуемо ведет к перекладке всех кабелей, включая силовой.
2. Установка второй точки, например на лоджии, что тоже влечет за собой расходы на прокладку слаботочных и силовых кабелей.

Выводы вытекающие из полученных диаграмм, такие: потратить определенную сумму денег и труда на оборудование и коммуникации.

Но, есть не менее эффективное и бесплатное решение. Прежде чем перейти к его описанию, нужно упомянуть не только недостатки программы, но и метода "сканирование ноутбуком".

### Сканирование ноутбуком

Считаю метод сканирования с ноутбуком не оптимальным по ряду причин:

1. Вес и габариты
2. Мощность
3. Не IoT

#### 1. Вес и габариты

Когда дело идет о собственной квартире, то легко организовать сканирование и с помощью стационарного ПК.

Но, ситуация меняется, когда данный процесс становится частым, профессиональным или с выездами. Помимо инструментов (дрель, отвертка, пассатижи, обжимка и т.д.) и устанавливаемого оборудования, придется с собой всегда носить ноутбук. Не говоря уже про тот факт, что те же датчики (пожарные, сигнализации и т.д.) в основном устанавливаются высоко под потолком. Нелепая картина - монтажник на 5 метровой стремянке с развернутым ноутбуком ))

#### 2. Мощность

Мощность антенны и самого встроенного mini-pci express адаптера wi-fi в ноутбуке заметно больше чему у IoT устройств, из-за тех же габаритов и небольшой энергоемкости у последних. Следовательно, не правильно и не показательно производить замеры более мощным устройством, ноутбуком.

#### 3. Не IoT

Ноутбук не IoT.
Смартфон наиболее приближен по размерам, мощностям и зачастую архитектурой процессора (ARM), к IoT. В плане компактности и легкости опережает самые легкие ноутбуки.

Со смартфоном можно измерять скорость сети или мобильного интернета даже сидя на дереве.

### Интерференция

Подсвеченная карта с помощью программы WiFi Surveyor, это предположительная оценка, которая может совершенно не соответствовать действительности. Т.к. данная карта не учитывает толщину стен, из какого материала изготовлена мебель и т.д.

Посмотрим на рисунок из раздела RSSI, из него следует, что у соседей сквозь толстую несущую стену, должен быть лучше интернет чем на моей кухне!?!

Самое главное что не учитывает WiFi Surveyor и то, что было упомянуто на семинаре, это интерференция.

Во-первых, интерференция возникает из-за увеличивающегося оборудования с wi-fi, в каждой квартире не по одной, а по несколько точек доступа, многие даже не догадываются что, например городской телефон, приходящей по оптике в GPON OLU, имеет по умолчанию включенный wi-fi. Многие приставки (видео, игровые), телевизоры, принтеры и мфу, также по умолчанию с включенным wi-fi. Наконец, количество телефонов, у многих людей не один смартфон. Все эти устройства постоянно что-то передают и принимают.

Во-вторых, сама реализация протокола IEEE 802.11 в частотном диапазоне 2.4ГГц подразумевает только 14 каналов. Более того, каналы привязаны к регионам и не все из них используются. В последующих реализациях IEEE 802.11ac (5ГГц) количество каналов было увеличено, но для РФ доступно только 33.

Помехи соседских точек доступа, работающих на том же канале, что наша точка доступа, более губительный фактор, чем несущие стены.

Непредсказуемость возникновения интерференции в определенных местах нашей квартиры объясняется тем, что соседи могут размещать точки доступа в любом месте своей территории. Такое влияние заметно на картинке из раздела SNR, где описываю отсутствие сигнала в санузлах.

Более показателен пример с разными расстояниями: в нижнем правом углу картинки SNR на лоджии -3дБ, а в гостиной в нижнем правом -9дБ, причем лоджия дальше в два раза чем гостиная от wi-fi точки доступа.

### Сканирование смартфоном

Есть большое количество ПО для работы с wifi для андроида. Использовал и продолжаю периодически пользоваться швейцарским ножиком в сетевой диагностике - программой [PingTools](https://play.google.com/store/apps/details?id=ua.com.streamsoft.pingtools).

<img src=pics/03.png width=300>

В свое время приобрел профессиональную версию данного ПО за 50 рублей ).

<img src=pics/04.jpg>

В связи с политикой play-маркета приобрести версию про не получится, но и бесплатной должно хватить с лихвой.

В нашем случае нужны только пару инструментов из всего многообразия: сканер wi-fi и iperf.

<div style="page-break-before: always;"></div>

#### WiFi Scanner до смены канала

Все замеры будут производиться в одной месте:

<img src=pics/05.png width=300>

На картинке отображен диапазон сканирования сетей wi-fi на частоте 2.4.ГГц. 

Сканер позволяет работать и в других диапазонах, это зависит от чипа смартфона.

**STR** - наша точка доступа работает на 6-ом канале частотного диапазона 2.4ГГц. 

Мощность сигнала -51дБ.

Первое, что бросается в глаза, большое количество точек доступа, они наслаиваются друг на друга, их названия затер в соответствии с законом о персданных. 

Показаны только те точки доступа, которые программа смартфона смогла зафиксировать за пару минут своей работы, на самом деле их еще больше.

Второе, что бросается в глаза - это полный штиль на 8-ом канале.

#### Iperf до смены канала

PingTools имеет в своем арсенале утилиту iperf, которую можно запускать как в режиме клиента, так и в режиме сервера.

<img src=pics/06.png width=300>

Скорости выгрузки и получения одинаковые, примерно 17 мегабит в секунду.

Изменим настройки точки доступа, и назначим ей свободный 8-канал.

<div style="page-break-before: always;"></div>

#### WiFi Scanner после смены канала

<img src=pics/07.png width=300>

На графике видно, что **STR** точка доступа занимает теперь восьмой канал, и даже немного увеличился уровень сигнала, который был -51 дБ, а стал -49дБ.

Это можно было бы списать на допустимую погрешность, но что покажет замер скорости iperf?

<div style="page-break-before: always;"></div>

#### Iperf после смены канала

<img src=pics/08.png width=300>

Итого: увеличение скорости более чем в три раза.

### Заключение

Данный пример показал, что без особых затрат можно существенно увеличить скорость в конкретно заданной точке.

Не факт, что в других местах квартиры скорость тоже увеличится. Так как мы имеем дело даже не с трехмерным пространством, а с пятимерным, где четвертым параметром является мощность сигнала, пятым время.

Для просчета всех возможных вариантов мощности сигнала в заданный промежуток времени в конкретной точке нашего объемного помещения, потребуются многослойные искусственные нейронные сети работающие не мощных серверах с GPU.

Из-за проблем интерференции, производители wi-fi оборудования добавляют новые частоты с большим количеством каналов: 5ГГц, далее 6ГГц, в планах другие частоты.

Вышеописанный метод "сканирования смартфоном" можно будет применить и в сфере IoT.
Уже сегодня умельцы собирают [конструкции](https://www.hackster.io/pulsartronic/diy-smartphone-lora-connection-bde258), которые совместно со смартфоном могут взаимодействовать по протоколу LoraWan.
Остается только написать программу LoraScan.
